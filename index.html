<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" href="images/favicon.png">

  <title>Dragalia Lost 3D Models</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <!-- Custom styles for this template -->
  <link href="css/sidebar.css" rel="stylesheet">

</head>

<body>

  <div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-light border-right" id="sidebar-wrapper">
      <div class="sidebar-heading">Settings </div>
      <form>
        <div class="form-group">
          <select class="form-control" id="char_set">
            <option selected = "selected" value = '0'>Regular Adventurers</option>
            <option value = '1'>Allies</option>
            <option value = '2'>Enemies</option>
          </select>
          <p style = "border-bottom: medium"></p>
          <div id="filter"> <!-- Filter -->
            <select class="form-control" id="raritySelect">
              <option selected = "selected">Any rarity</option>
              <option>3 stars</option>
              <option>4 stars</option>
              <option>5 stars</option>
            </select>
            <select class="form-control" id="elementSelect">
              <option selected = "selected">Any element</option>
              <option>Flame</option>
              <option>Water</option>
              <option>Wind</option>
              <option>Light</option>
              <option>Shadow</option>
            </select>
            <select class="form-control" id="weaponSelect">
            <option selected = "selected">Any weapon</option>
            <option>Sword</option>
            <option>Blade</option>
            <option>Dagger</option>
            <option>Axe</option>
            <option>Lance</option>
            <option>Bow</option>
            <option>Wand</option>
            <option>Staff</option>
          </select>
          </div>
          <p style = "font-size:small"></p>
          <select class="form-control mt-0 bg-light" id="advSelect" style = "width: 15rem" autofocus>
          </select>
          <p style = "font-size:small"></p>
          <select class="form-control" id="faceSelect" style = 'display:none'>
            <option value ='1'>Face 1</option>
            <option selected = "selected" value = '2'>Face 2</option>
            <option value = '3'>Face 3</option>
            <option value = '4'>Face 4</option>
            <option value = '5'>Face 5</option>
            <option value = '6'>Face 6</option>
            <option value = '7'>Face 7</option>
            <option value = '8'>Face 8</option>
            <option value = '9'>Face 9</option>
          </select>
        </div>
      </form>
      <div id = 'ctrl_btn' style = 'display:none;text-align:center;'>
        <div class = "button-toolbar mb-1">
          <button id = 'still_btn' class="btn btn-info">Still</button>
          <button id = 'bob_btn' class="btn btn-info">Bob</button>
        </div>
        <div class = "button-toolbar mb-0">
          <button id = 'walk_btn' class="btn btn-info">Walk</button>
          <button id = 'run_btn' class="btn btn-info">Run</button>
        </div>
        <br style = "font-size:small">
        <p class = 'mt-6 mb-0 border-top' style="padding-left: 10px;width:100%">Win animation settings</p>
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
          <label class="btn btn-secondary active" id="defaultWin">
            <input type="radio" name="winstyle" id="defaultWinbtn" checked>Default
          </label>
          <label class="btn btn-secondary" id="weaponWin">
            <input type="radio" name="winstyle" id="weaponWinbtn">Weapon
          </label>
          <label class="btn btn-secondary" id="spWin">
            <input type="radio" name="winstyle">Special
          </label>
        </div>
        <p style = "font-size:small"></p>
        <select class="form-control" id="weaponWStyle" style = 'display:none'>
          <option selected = "selected" value ='SWD'>Sword</option>
          <option value = 'KAT'>Blade</option>
          <option value = 'DAG'>Dagger</option>
          <option value = 'AXE'>Axe</option>
          <option value = 'LAN'>Lance</option>
          <option value = 'BOW'>Bow</option>
          <option value = 'ROD'>Wand</option>
          <option value = 'CAN'>Staff</option>
        </select>
        <select class="form-control" id="spWStyle" style = "display:none">
        </select>
        <button id = 'win_btn' class="btn btn-success" style = "width:100%;">Win</button>
      </div>
      <a href='' target="_blank" id='currentLink' style = "display:none">Link of current animation</a>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar navbar-expand-sm navbar-light">
        <button class="btn btn-primary" id="menu-toggle">Settings</button>
        <span style="padding-left:5px"></span>
        <p class ="nav-item"> Using resources from <a href="https://notte.moe/" target="_blank">notte.moe</a></p>
      </nav>

      <div class="container-fluid">
        <iframe id="ifm" src="" style="height:500px; width:500px; border: none"></iframe>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

  <!-- Menu Toggle Script -->
  <script>
    $("#menu-toggle").click(function(e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
    });
    var buffer = 20; //scroll bar buffer
    var iframe = document.getElementById('ifm');

    function pageY(elem) {
        return elem.offsetParent ? (elem.offsetTop + pageY(elem.offsetParent)) : elem.offsetTop;
    }

    function pageX(elem) {
        return elem.offsetParent ? (elem.offsetLeft + pageX(elem.offsetParent)) : elem.offsetLeft;
    }

    function resizeIframe() {

        var width = document.documentElement.clientWidth;
        var height = document.documentElement.clientHeight;
        if (width >= 768)
        {
          width -= pageX(document.getElementById('ifm'))+ buffer ;
          width = (width < 0) ? 0 : width;
          height -= pageY(document.getElementById('ifm'))+ buffer ;
          height = (height < 0) ? 0 : height;
        }
        else
        {
          height -= pageY(document.getElementById('ifm'))+ buffer ;
          height = (height < 0) ? 0 : height;
        }
        var size = (width > height) ? height : width;
        iframe.style.height = size + 'px';
        iframe.style.width = size + 'px';
    }

    // .onload doesn't work with IE8 and older.
    if (iframe.attachEvent) {
        iframe.attachEvent("onload", resizeIframe);
    } else {
        iframe.onload=resizeIframe;
    }

    window.onresize = resizeIframe;
    window.onload = resizeIframe;
  </script>
  <!-- Other Scripts -->
  <script type='module'>
    import adv from './js/adv_list.js';
    import sp_adv from './js/sp_adv.js';
    import allies from './js/allies.js';
    import enemy from './js/enemy.js';
    adv.sort((a, b) => a.name.localeCompare(b.name)); // Sort adv by name
    sp_adv.sort((a, b) => a.name.localeCompare(b.name));

    let advBox = document.getElementById('advSelect');
    let spwinbox = document.getElementById('spWStyle');

    var wintype = 0;  // default
    var ch_set = '0';

    function defaultWinClicked()
    {
      if (wintype === 0)
      {
        return false;
      }
      document.getElementById('weaponWStyle').style.display= 'none';
      document.getElementById('spWStyle').style.display= 'none';
      wintype = 0;
    }

    function weaponWinClicked()
    {
      if (wintype === 1)
      {
        return false;
      }
      document.getElementById('weaponWStyle').style.display= 'block';
      document.getElementById('spWStyle').style.display= 'none';
      wintype = 1;
    }

    function spWinClicked()
    {
      if (wintype === 2)
      {
        return false;
      }
      document.getElementById('weaponWStyle').style.display= 'none';
      document.getElementById('spWStyle').style.display= 'block';
      wintype = 2;
    }

    function loadSpWin()
    {
      spwinbox.innerHTML = '';
      sp_adv.forEach(spwinhandle);
    }

    function loadAllies()
    {
      advBox.innerHTML = '';
      var listItem = document.createElement('option');
      listItem.innerHTML = 'Choose a character';
      listItem.value = '0';
      listItem.disabled = 'disabled';
      listItem.selected = 'selected';
      advBox.appendChild(listItem);

      allies.forEach(advhandle);
    }

    function loadEnemy()
    {
      advBox.innerHTML = '';
      var listItem = document.createElement('option');
      listItem.innerHTML = 'Choose a character';
      listItem.value = '0';
      listItem.disabled = 'disabled';
      listItem.selected = 'selected';
      advBox.appendChild(listItem);

      enemy.forEach(advhandle);
    }

    function charSetChanged()
    {
      ch_set = document.getElementById('char_set').value;
      switch (ch_set)
      {
        case '0':
          document.getElementById('filter').style.display= 'block';
          filter();
          break;
        case '1': // allies
          document.getElementById('filter').style.display= 'none';
          loadAllies();
          break;
        case '2': // enemy
          document.getElementById('filter').style.display= 'none';
          loadEnemy();
          break;
      }
    }

    function spwinhandle(sp_adv)
    {
      var listItem = document.createElement('option');
      listItem.innerHTML = sp_adv.name;
      listItem.value = sp_adv.cid;
      spwinbox.appendChild(listItem);
    }

    function filter()
    {
      let weapon = document.getElementById('weaponSelect').value;
      let rarity = document.getElementById('raritySelect').value[0];
      let ele = document.getElementById('elementSelect').value;
      let result = adv;
      if (weapon != 'Any weapon')
      {
        result = result.filter(d => d.weapon === weapon);
      }
      if (rarity != 'A')
      {
        result = result.filter(d => d.rarity === parseInt(rarity));
      }
      if (ele != 'Any element')
      {
        result = result.filter(d => d.element === ele);
      }

      advBox.innerHTML = '';
      var listItem = document.createElement('option');
      listItem.innerHTML = 'Choose an adventurer';
      listItem.value = '0';
      listItem.disabled = 'disabled';
      listItem.selected = 'selected';
      advBox.appendChild(listItem);

      result.forEach(advhandle);
    }

    function advhandle(adv)
    {
      let img_link = 'images/icon/' + adv.cid + '_r0' + adv.rarity + '.png';
      var listItem = document.createElement('option');
      listItem.innerHTML = adv.name;
      listItem.value = adv.cid;
      advBox.appendChild(listItem);
    }

    function advSelected()
    {
      let selected = document.getElementById('advSelect');
      let face = document.getElementById('faceSelect').value;
      let cid = selected.value;
      document.getElementById('faceSelect').style.display= 'block';  // Show face control
      document.getElementById('ctrl_btn').style.display= 'block';  // Show control button
      document.getElementById('currentLink').style.display= 'block';

      let link = "https://notte.moe/dl-fbx/c" + cid +'/-/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function faceSelected()
    {
      let cid = document.getElementById('advSelect').value;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = iframe.src
      link = link.substr(0,link.length-1) + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Still()
    {
      let cid = document.getElementById('advSelect').value;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = "https://notte.moe/dl-fbx/c" + cid +'/-/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Bob()
    {
      let cid = document.getElementById('advSelect').value;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = "https://notte.moe/dl-fbx/c" + cid + "/cmn+CMN_MWM_03" + '/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Walk()
    {
      let cid = document.getElementById('advSelect').value;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = "https://notte.moe/dl-fbx/c" + cid + "/cmn+CMN_MWM_01" + '/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Run()
    {
      let cid = document.getElementById('advSelect').value;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = "https://notte.moe/dl-fbx/c" + cid + "/cmn+CMN_MWM_02" + '/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Win()
    {
      let cid = document.getElementById('advSelect').value;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let sp = 0;   // equals 1 if playing special animation
      let wid = cid;  // id of the final animation
      if (wintype == 2) // special animation
      {
        wid = document.getElementById('spWStyle').value;
        sp = 1;
      }
      let temp = sp_adv.find(d => d.cid === cid);
      if (type(temp) != undefined) // Not a special adventurer
      {
        sp = 1;  // cid is from a special adventurer
      }
      if (wintype == 1)
      {
        sp = 0;
      }

      let wincode = '';
      let weapon = '';

      if (wintype != 1)
      {
        if (wintype == 0)
          if (char_set != '0')
          {
            weapon = "Sword"
          }
          else
          {
            temp = adv.filter(d => d.cid === cid);
            weapon = temp[0].weapon;
          }
        else // wintype = 2, special animation
        {
          temp = sp_adv.filter(d => d.cid === wid);
          weapon = temp[0].weapon;
        }
        switch (weapon)
          {
            case 'Sword':
              wincode = 'SWD';
              break;
            case 'Blade':
              wincode = 'KAT';
              break;
            case 'Dagger':
              wincode = 'DAG';
              break;
            case 'Axe':
              wincode = 'AXE';
              break;
            case 'Lance':
              wincode = 'LAN';
              break;
            case 'Bow':
              wincode = 'BOW';
              break;
            case 'Wand':
              wincode = 'ROD';
              break;
            case 'Staff':
              wincode = 'CAN';
              break;
          }
      }
      else {
        wincode = document.getElementById('weaponWStyle').value;
      }
      let link = '';
      if (sp == 0)
      {
        link = "https://notte.moe/dl-fbx/c" + cid + "/win+" + wincode + "_WIN_01" + '/face' + face;
      }
      else
      {
        link = "https://notte.moe/dl-fbx/c" + cid + "/wins+" + wincode + "_WIN_01_" + wid.replace('_','') + '/face' + face;
      }
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function init()
    {
      resizeIframe();
      filter();
      loadSpWin();
      document.getElementById('char_set').addEventListener("change", charSetChanged);
      document.getElementById('weaponSelect').addEventListener("change", filter);
      document.getElementById('raritySelect').addEventListener("change", filter);
      document.getElementById('elementSelect').addEventListener("change", filter);
      document.getElementById('advSelect').addEventListener("change", advSelected);
      document.getElementById('faceSelect').addEventListener("change", faceSelected);
      document.getElementById('defaultWin').addEventListener("click", defaultWinClicked);
      document.getElementById('weaponWin').addEventListener("click", weaponWinClicked);
      document.getElementById('spWin').addEventListener("click", spWinClicked);
      document.getElementById('still_btn').addEventListener("click", Still);
      document.getElementById('bob_btn').addEventListener("click", Bob);
      document.getElementById('walk_btn').addEventListener("click", Walk);
      document.getElementById('run_btn').addEventListener("click", Run);
      document.getElementById('win_btn').addEventListener("click", Win);
    }

    window.onload = init;
  </script>
</body>

</html>
