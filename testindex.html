<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" href="images/favicon.png">

  <title>Dragalia Lost 3D Models</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <!-- Custom styles for this template -->
  <link rel="stylesheet" href="./css/styles.css">
  <link href="css/sidebar.css" rel="stylesheet">


</head>

<body>
  <div class="modal fade w-100 h-100" id="SelectBox" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog m-3 p-0" role="document" style="max-width:95%">
      <div class="modal-content">
        <div class="modal-header pt-3 border-0 pb-1">
          <h5 class="modal-title mx-auto">Choose an adventurer</h5>
          <button type="button" class="close float-right mx-0" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Placeholder for filter -->
          <div class = "card mx-auto filter_box pb-2 pt-0" style="margin-top:0px;">
            <div class = "btn-toolbar" id ='filter'></div>
          </div>
          <!-- Placeholder for adventurer cards -->
          <div class="card-deck justify-content-center" id="card_list" style="margin-top:10px; margin-left:15px; margin-right:15px"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-light border-right" id="sidebar-wrapper">
      <div class="sidebar-heading">Settings </div>
      <form>
        <div class="form-group">
          <select class="form-control" id="char_set" style = "width: 15rem">
            <option selected = "selected" value = '0'>Regular Adventurers</option>
            <option value = '1'>Allies</option>
            <option value = '2'>Enemies</option>
          </select>
          <button type="button" class="btn btn-primary w-100" data-toggle="modal" data-target="#SelectBox" id='chooseBtn' style='margin-top:10px; margin-bottom:10px'>Choose an Adventurer</button>
          <div id='selectedAdvId' style='display:none'></div>
          <select class="form-control bg-light" id="advSelect" style = "width: 15rem; display:none; margin-top:10px; margin-bottom:10px" autofocus>
          </select>
          <select class="form-control" id="faceSelect" style = 'display:none'>
            <option value ='1'>Face 1</option>
            <option selected = "selected" value = '2'>Face 2</option>
            <option value = '3'>Face 3</option>
            <option value = '4'>Face 4</option>
            <option value = '5'>Face 5</option>
            <option value = '6'>Face 6</option>
            <option value = '7'>Face 7</option>
            <option value = '8'>Face 8</option>
            <option value = '9'>Face 9</option>
          </select>
        </div>
      </form>
      <div id = 'ctrl_btn' style = 'display:none;text-align:center;'>
        <div class = "button-toolbar mb-1">
          <button id = 'still_btn' class="btn btn-info">Still</button>
          <button id = 'bob_btn' class="btn btn-info">Bob</button>
        </div>
        <div class = "button-toolbar mb-0">
          <button id = 'walk_btn' class="btn btn-info">Walk</button>
          <button id = 'run_btn' class="btn btn-info">Run</button>
        </div>
        <p class = 'mb-0 border-top' style="margin-top:10px;padding-left: 10px;width:100%">Win animation settings</p>
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
          <label class="btn btn-secondary active" id="defaultWin">
            <input type="radio" name="winstyle" id="defaultWinbtn" checked>Default
          </label>
          <label class="btn btn-secondary" id="weaponWin">
            <input type="radio" name="winstyle" id="weaponWinbtn">Weapon
          </label>
          <label class="btn btn-secondary" id="spWin">
            <input type="radio" name="winstyle">Special
          </label>
        </div>
        <p style = "font-size:small"></p>
        <select class="form-control" id="weaponWStyle" style = 'display:none'>
          <option selected = "selected" value ='SWD'>Sword</option>
          <option value = 'KAT'>Blade</option>
          <option value = 'DAG'>Dagger</option>
          <option value = 'AXE'>Axe</option>
          <option value = 'LAN'>Lance</option>
          <option value = 'BOW'>Bow</option>
          <option value = 'ROD'>Wand</option>
          <option value = 'CAN'>Staff</option>
        </select>
        <select class="form-control" id="spWStyle" style = "display:none">
        </select>
        <button id = 'win_btn' class="btn btn-success" style = "width:100%;">Win</button>
      </div>
      <a href='' target="_blank" id='currentLink' style = "display:none">Link of current animation</a>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar navbar-expand-sm navbar-light">
        <button class="btn btn-primary" id="menu-toggle">Settings</button>
        <span style="padding-left:5px"></span>
        <p class ="nav-item"> Using resources from <a href="https://notte.moe/" target="_blank">notte.moe</a></p>
      </nav>

      <div class="container-fluid">
        <iframe id="ifm" src="" style="height:500px; width:500px; border: none"></iframe>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

  <!-- Menu Toggle Script -->
  <script>
    $("#menu-toggle").click(function(e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
    });
    var buffer = 20; //scroll bar buffer
    var iframe = document.getElementById('ifm');

    function pageY(elem) {
        return elem.offsetParent ? (elem.offsetTop + pageY(elem.offsetParent)) : elem.offsetTop;
    }

    function pageX(elem) {
        return elem.offsetParent ? (elem.offsetLeft + pageX(elem.offsetParent)) : elem.offsetLeft;
    }

    function resizeIframe() {

        var width = document.documentElement.clientWidth;
        var height = document.documentElement.clientHeight;
        if (width >= 768)
        {
          width -= pageX(document.getElementById('ifm'))+ buffer ;
          width = (width < 0) ? 0 : width;
          height -= pageY(document.getElementById('ifm'))+ buffer ;
          height = (height < 0) ? 0 : height;
        }
        else
        {
          height -= pageY(document.getElementById('ifm'))+ buffer ;
          height = (height < 0) ? 0 : height;
        }
        var size = (width > height) ? height : width;
        iframe.style.height = size + 'px';
        iframe.style.width = size + 'px';
    }

    // .onload doesn't work with IE8 and older.
    if (iframe.attachEvent) {
        iframe.attachEvent("onload", resizeIframe);
    } else {
        iframe.onload=resizeIframe;
    }

    window.onresize = resizeIframe;
    window.onload = resizeIframe;
  </script>
  <!-- Other Scripts -->
  <script type='module'>
    import adv from 'https://dgk3593.github.io/cs50web-project0/js/adv_list_full.js';
    import sp_adv from 'https://dgk3593.github.io/DLModel/js/sp_adv.js';
    import allies from 'https://dgk3593.github.io/DLModel/js/allies.js';
    import enemy from 'https://dgk3593.github.io/DLModel/js/enemy.js';
    adv.sort((a, b) => a.name.localeCompare(b.name)); // Sort adv by name
    sp_adv.sort((a, b) => a.name.localeCompare(b.name));

    let advBox = document.getElementById('advSelect');
    let spwinbox = document.getElementById('spWStyle');

    var wintype = 0;  // default
    var ch_set = '0';
    var card_list = document.getElementById('card_list');
    // Sort list by rarity then name
    // Sort by name first
    adv.sort((a, b) => a.name.localeCompare(b.name));
    // Then sort by rarity
    adv.sort(function(a,b){
      return b.rarity - a.rarity;
    });

    var rarity_cond = [];
    var wea_cond = [];
    var ele_cond =[];
    var checked = {};

    const filters = {rarity:[3, 4, 5],
                    ele:['Flame', 'Water', 'Wind', 'Light', 'Shadow'],
                    wea:['Sword', 'Blade', 'Dagger', 'Axe', 'Lance', 'Bow', 'Wand', 'Staff']
                    };

    function createFilter(key, e){
      let label = document.createElement('label');
      label.className = "btn btn-light border-dark";

      let input = document.createElement('input');
      input.type = 'checkbox';
      input.name = key;
      input.setAttribute('data', e);
      input.autocomplete = 'off';
      label.appendChild(input);

      let img = document.createElement('img');
      img.src = 'images/' + key + '_' + e + '.png';
      img.className = "filterIcon";
      label.appendChild(img);

      return label;
    }

    function createFilterGroup(key, el){
      let filter_box = document.getElementById('filter');
      let filter_group = document.createElement('div');
      filter_group.className = "btn-group-toggle btn-group mx-auto";
      filter_group.setAttribute('role', "group");
      filter_group.setAttribute('data-toggle', 'buttons');
      el.forEach((item, i) => {
        let label = createFilter(key, item);
        filter_group.appendChild(label);
      });
      filter_box.appendChild(filter_group);
    }


    function getChecked(name) {
      checked[name] = Array.from(document.querySelectorAll('input[name=' + name + '][value = "on"]')).map(function (el) {
        return el.getAttribute('data');
      });
    }

    function updateRarity() {
      getChecked('rarity');
      rarity_cond = checked['rarity'].map(Number);
      if (rarity_cond.length == 0){
        rarity_cond = filters['rarity'];
      }
    }

    function updateWeapon() {
      getChecked('wea');
      wea_cond = checked['wea'];
      if (wea_cond.length == 0){
        wea_cond = filters['wea'];
      }
    }

    function updateElement() {
      getChecked('ele');
      ele_cond = checked['ele'];
      if (ele_cond.length == 0){
        ele_cond = filters['ele'];
      }
    }

    function filter() {
      updateRarity();
      updateWeapon();
      updateElement();
      card_list.innerHTML = '';
      let temp_list = adv;
      temp_list = temp_list.filter(d => rarity_cond.includes(d.rarity));
      temp_list = temp_list.filter(d => wea_cond.includes(d.weapon));
      temp_list = temp_list.filter(d => ele_cond.includes(d.element));
      temp_list.forEach(advhandleCard);
    }

    function advhandle(adv)
    {
      let img_link = 'images/icon/' + adv.cid + '_r0' + adv.rarity + '.png';
      var listItem = document.createElement('option');
      listItem.innerHTML = adv.name;
      listItem.value = adv.cid;
      advBox.appendChild(listItem);
    }

    function advhandleCard(adv) {
      let img_link = 'images/full_body_300/' + adv.cid + '.png';

      let tmpCard = document.createElement('div');
      tmpCard.className = "card text-center border-primary rounded";
      tmpCard.cid = adv.cid;
      tmpCard.style="min-width:200px;max-width:200px;margin:5px; padding:5px;";
      tmpCard.onclick = function(){
        document.getElementById('selectedAdvId').innerHTML = adv.cid;
        $('#SelectBox').modal('hide');
        advSelected();
      };

      let title = document.createElement('h5');
      title.className = "card-title mb-0";
      title.innerHTML = adv.name;
      tmpCard.appendChild(title);

      let subtitle = document.createElement('h6');
      subtitle.className = "card-text mb-2 text-muted";
      subtitle.innerHTML = adv.title;
      tmpCard.appendChild(subtitle);

      let r_img = document.createElement('img');
      r_img.style = "margin:auto";
      r_img.src = 'images/rarity_' + adv.rarity + '_line.png';
      tmpCard.appendChild(r_img);

      let img = document.createElement('img');
      img.className = "card-img-top my-3";
      img.style = "max-width:200px; margin:auto";
      img.src = img_link;
      tmpCard.appendChild(img);

      let icons = document.createElement('div');
      icons.className = "row cardIcon";
      icons.style="margin:auto";
      let icon1 = document.createElement('img');
      icon1.style = "margin-right:5px";
      icon1.src = 'images/ele_' + adv.element + '.png';
      icons.appendChild(icon1);
      let icon2 = document.createElement('img');
      icon2.src = 'images/wea_' + adv.weapon + '.png';
      icons.appendChild(icon2);
      tmpCard.appendChild(icons);

      card_list.appendChild(tmpCard);
    }

    function defaultWinClicked()
    {
      if (wintype === 0)
      {
        return false;
      }
      document.getElementById('weaponWStyle').style.display= 'none';
      document.getElementById('spWStyle').style.display= 'none';
      wintype = 0;
    }

    function weaponWinClicked()
    {
      if (wintype === 1)
      {
        return false;
      }
      document.getElementById('weaponWStyle').style.display= 'block';
      document.getElementById('spWStyle').style.display= 'none';
      wintype = 1;
    }

    function spWinClicked()
    {
      if (wintype === 2)
      {
        return false;
      }
      document.getElementById('weaponWStyle').style.display= 'none';
      document.getElementById('spWStyle').style.display= 'block';
      wintype = 2;
    }

    function loadSpWin()
    {
      spwinbox.innerHTML = '';
      sp_adv.forEach(spwinhandle);
    }

    function loadAllies()
    {
      advBox.innerHTML = '';
      var listItem = document.createElement('option');
      listItem.innerHTML = 'Choose a character';
      listItem.value = '0';
      listItem.disabled = 'disabled';
      listItem.selected = 'selected';
      advBox.appendChild(listItem);

      allies.forEach(advhandle);
    }

    function loadEnemy()
    {
      advBox.innerHTML = '';
      var listItem = document.createElement('option');
      listItem.innerHTML = 'Choose a character';
      listItem.value = '0';
      listItem.disabled = 'disabled';
      listItem.selected = 'selected';
      advBox.appendChild(listItem);

      enemy.forEach(advhandle);
    }

    function charSetChanged()
    {
      ch_set = document.getElementById('char_set').value;
      switch (ch_set)
      {
        case '0':
          document.getElementById('advSelect').style.display= 'none';
          break;
        case '1': // allies
          document.getElementById('advSelect').style.display= 'block';
          document.getElementById('chooseBtn').style.display= 'none';
          loadAllies();
          break;
        case '2': // enemy
          document.getElementById('advSelect').style.display= 'block';
          document.getElementById('chooseBtn').style.display= 'none';
          loadEnemy();
          break;
      }
    }

    function spwinhandle(sp_adv)
    {
      var listItem = document.createElement('option');
      listItem.innerHTML = sp_adv.name;
      listItem.value = sp_adv.cid;
      spwinbox.appendChild(listItem);
    }


    function advSelected()
    {
      let selected = '';
      let cid = '';

      if (ch_set != '0'){
        selected = document.getElementById('advSelect');
        cid = selected.value;
        document.getElementById('selectedAdvId').innerHTML = cid;
      }
      else {
        cid = document.getElementById('selectedAdvId').innerHTML;
      }

      document.getElementById('faceSelect').style.display= 'block';  // Show face control
      document.getElementById('ctrl_btn').style.display= 'block';  // Show control button
      document.getElementById('currentLink').style.display= 'block';
      let face = document.getElementById('faceSelect').value;

      let link = "https://notte.moe/dl-fbx/c" + cid +'/-/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function faceSelected()
    {
      let cid = document.getElementById('selectedAdvId').innerHTML;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = iframe.src
      link = link.substr(0,link.length-1) + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Still()
    {
      let cid = document.getElementById('selectedAdvId').innerHTML;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = "https://notte.moe/dl-fbx/c" + cid +'/-/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Bob()
    {
      let cid = document.getElementById('selectedAdvId').innerHTML;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = "https://notte.moe/dl-fbx/c" + cid + "/cmn+CMN_MWM_03" + '/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Walk()
    {
      let cid = document.getElementById('selectedAdvId').innerHTML;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = "https://notte.moe/dl-fbx/c" + cid + "/cmn+CMN_MWM_01" + '/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Run()
    {
      let cid = document.getElementById('selectedAdvId').innerHTML;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let link = "https://notte.moe/dl-fbx/c" + cid + "/cmn+CMN_MWM_02" + '/face' + face;
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }

    function Win()
    {
      let cid = document.getElementById('selectedAdvId').innerHTML;
      let face = document.getElementById('faceSelect').value;
      if (cid === '0')
      {
        return false;
      }
      let sp = 0;   // equals 1 if playing special animation
      let wid = cid;  // id of the final animation
      if (wintype == 2) // special animation
      {
        wid = document.getElementById('spWStyle').value;
        sp = 1;
      }
      let temp = sp_adv.find(d => d.cid === cid);
      if (typeof(temp) != 'undefined') // Not a special adventurer
      {
        sp = 1;  // cid is from a special adventurer
      }
      if (wintype == 1)
      {
        sp = 0;
      }
      console.log('wintype: ' + wintype + ', sp: ' + sp);
      let wincode = '';
      let weapon = '';

      if (wintype != 1)
      {
        if (wintype == 0)
          if (ch_set != '0')
          {
            weapon = "Sword"
          }
          else
          {
            temp = adv.find(d => d.cid === cid);
            weapon = temp.weapon;
          }
        else // wintype = 2, special animation
        {
          temp = sp_adv.find(d => d.cid === wid);
          weapon = temp.weapon;
          console.log(weapon);
        }
        switch (weapon)
          {
            case 'Sword':
              wincode = 'SWD';
              break;
            case 'Blade':
              wincode = 'KAT';
              break;
            case 'Dagger':
              wincode = 'DAG';
              break;
            case 'Axe':
              wincode = 'AXE';
              break;
            case 'Lance':
              wincode = 'LAN';
              break;
            case 'Bow':
              wincode = 'BOW';
              break;
            case 'Wand':
              wincode = 'ROD';
              break;
            case 'Staff':
              wincode = 'CAN';
              break;
          }
      }
      else {
        wincode = document.getElementById('weaponWStyle').value;
      }
      let link = '';
      if (sp == 0)
      {
        link = "https://notte.moe/dl-fbx/c" + cid + "/win+" + wincode + "_WIN_01" + '/face' + face;
      }
      else
      {
        link = "https://notte.moe/dl-fbx/c" + cid + "/wins+" + wincode + "_WIN_01_" + wid.replace('_','') + '/face' + face;
      }
      iframe.src = link;
      document.getElementById('currentLink').href = link;
    }


    function init()
    {
      resizeIframe();
      filter();
      loadSpWin();
      document.getElementById('char_set').addEventListener("change", charSetChanged);
      document.getElementById('selectedAdvId').addEventListener("change", advSelected);
      document.getElementById('faceSelect').addEventListener("change", faceSelected);
      document.getElementById('defaultWin').addEventListener("click", defaultWinClicked);
      document.getElementById('weaponWin').addEventListener("click", weaponWinClicked);
      document.getElementById('spWin').addEventListener("click", spWinClicked);
      document.getElementById('still_btn').addEventListener("click", Still);
      document.getElementById('bob_btn').addEventListener("click", Bob);
      document.getElementById('walk_btn').addEventListener("click", Walk);
      document.getElementById('run_btn').addEventListener("click", Run);
      document.getElementById('win_btn').addEventListener("click", Win);
      // Generates filters
      for(var key in filters){
        let value = filters[key];
        createFilterGroup(key, value);
      }

      // Add toggle on click to all filter
      $('#filter label').each(function(){
        $(this).on('click',function filterClicked(e){
          let value = this.children[[0]].value;
          this.children[[0]].value = value === 'on' ? 'off' : 'on';
          filter();
        });
      });

      $('input[type=checkbox]').val('off'); // Reset filters
      filter();
    }

    window.onload = init;
  </script>
</body>

</html>
